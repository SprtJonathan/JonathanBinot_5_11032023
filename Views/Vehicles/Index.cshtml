@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@model IEnumerable<ExpressVoitures.Data.Vehicle>

@{
    ViewData["Title"] = "Annonces";
}

<h1>Annonces</h1>

@if (SignInManager.IsSignedIn(User))
{
    <p>
        <a class="create-element" asp-action="Create">Ajouter une annonce</a>
    </p>
}
<section class="annonce-filtre-container">
    <div class="d-flex justify-content-center">
        <button class="btn button-annonce-filtre" type="button" data-toggle="collapse" data-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
            Filtrer
        </button>
    </div>
    <div class="collapse" id="filterCollapse">
        <form class="card card-body flex-row row" method="get" asp-action="Index">
            <div class="form-group col">
                <label class="control-label">Marque</label>
                <select id="marqueSelect" name="MarqueId" class="form-control" onchange="updateModeleSelect()" value=@ViewBag.Filters.MarqueId>
                    <option value="">Sélectionner une marque</option>
                    @foreach (var marque in ViewBag.Marques)
                    {
                        <option value="@marque.Id">@marque.Nom</option>
                    }
                </select>
            </div>
            <div class="form-group col">
                <label class="control-label">Modèle</label>
                <select id="modeleSelect" name="ModeleId" class="form-control" onchange="updateFinitionSelect()" disabled value="(@ViewBag.Filters.ModeleId)"><option value=(@ViewBag.Filters.MarqueId)>Sélectionner un modèle</option></select>
            </div>
            <div class="form-group col">
                <label class="control-label">Finition</label>
                <select id="finitionSelect" name="FinitionId" class="form-control" disabled value="(@ViewBag.Filters.FinitionId)"><option value=(@ViewBag.Filters.MarqueId)>Sélectionner une finition</option></select>
            </div>
            <div class="form-group col">
                <label class="control-label">Année</label>
                <input type="number" name="Annee" class="form-control" />
            </div>
            <div class="form-group d-flex justify-content-center">
                <button type="submit" class="btn button-annonce-filtre">Rechercher</button>
            </div>
        </form>
    </div>
</section>
<section id="offer-section" class="d-flex flex-lg-wrap align-items-center justify-content-start annonce-container">
    @foreach (var item in Model)
    {
        <div id="vehicle-@item.Id-block" class="annonce">
            <a asp-action="Listing" asp-route-id="@item?.Id" class="text-decoration-none">
                <figure class="card-header d-flex align-items-center justify-content-between annonce-block">
                    <div class="annonce-image-container">
                        <img class="annonce-image" src="@(item.Images != null && item.Images.Any() ? item.Images.FirstOrDefault().ImageLink : "/img/general/media-unavailable.png")" />
                    </div>
                    <figcaption class="annonce-text-block">
                        <div class="d-flex flex-column">
                            <span class="annonce-titre">
                                @Html.DisplayFor(modelItem => item.Marque.Nom) @Html.DisplayFor(modelItem => item.Modele.Nom)
                            </span>
                            <span class="annonce-texte">@Html.DisplayFor(modelItem => item.Finition.Nom)</span>
                            <span class="annonce-texte">@Html.DisplayFor(modelItem => item.Annee)</span>
                        </div>
                        <div class="annonce-prix-edit">

                            <span class="annonce-prix">
                                @Html.DisplayFor(modelItem => item.PrixVente) €
                            </span>

                        </div>
                    </figcaption>
                </figure>
            </a>
            @if (SignInManager.IsSignedIn(User))
            {
                <div class="annonce-edit-block">
                    <a class="btn icon-link" asp-action="AdminIndex" title="Retour à la liste administrateur">📋</a>
                    <a class="btn icon-link" asp-action="Edit" asp-route-id="@item?.Id" onclick="logIssue">🖋️</a>
                    <a class="btn icon-link" asp-action="Delete" asp-route-id="@item?.Id">❌</a>
                </div>
            }
        </div>
    }
</section>
<script>
    function updateModeleSelect() {
        updateSelect("marqueSelect", "modeleSelect", @Html.Raw(Json.Serialize(ViewBag.Modeles)), "id", "marqueId");
        updateFinitionSelect();
    }

    function updateFinitionSelect() {
        updateSelect("modeleSelect", "finitionSelect", @Html.Raw(Json.Serialize(ViewBag.Finitions)), "id", "modeleId");
    }
</script>
